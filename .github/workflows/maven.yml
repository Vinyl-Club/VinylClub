name: Java CI with Maven

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

concurrency:
  group: maven-back-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: List files in BACK
        run: ls -la BACK

      - name: Build & Test all services
        run: |
          set -euo pipefail

          SERVICES=(
            vinyl-discovery-service
            vinyl-auth-service
            vinyl-user-service
            vinyl-catalog-service
            vinyl-favorites-service
            vinyl-gateway-service
            vinyl-ad-service
          )

          for svc in "${SERVICES[@]}"; do
            echo "=============================="
            echo "Service: $svc"
            echo "=============================="

            if [ ! -f "BACK/$svc/pom.xml" ]; then
              echo "pom.xml not found in $svc!"
              exit 1
            fi

            cd "BACK/$svc"

            # verify = lance tests unitaires (Surefire) + packaging
            mvn -B -ntp clean verify

            cd - >/dev/null
          done

      # Upload des rapports de tests (même si ça échoue)
      - name: Upload Surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            BACK/**/target/surefire-reports/**
          if-no-files-found: ignore
